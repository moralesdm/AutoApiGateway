      - name: SSH into EC2 and deploy API Gateway
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          envs: SERVICE1_HOST,SERVICE1_PORT,SERVICE2_HOST,SERVICE2_PORT,SERVICE3_HOST,SERVICE3_PORT,SERVICE4_HOST,SERVICE4_PORT
          script: |
            set -e

            echo "ðŸ” Checking Docker installation..."
            if ! command -v docker &> /dev/null; then
              echo "ðŸ“¦ Installing Docker..."
              sudo apt-get update -y
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
            else
              echo "âœ… Docker is already installed."
            fi

            echo "ðŸ” Checking Docker Compose..."
            if ! docker compose version &> /dev/null; then
              echo "ðŸ”§ Installing Docker Compose plugin..."
              sudo apt-get install -y docker-compose-plugin || sudo apt-get install -y docker-compose
            else
              echo "âœ… Docker Compose already installed."
            fi

            cd /home/${{ secrets.EC2_USER }}/api-gateway

            echo "ðŸ§¹ Removing old container if exists..."
            sudo docker rm -f api-gateway-api-gateway-1 || true

            echo "ðŸ›‘ Stopping docker compose (if running)..."
            SERVICE1_HOST=$SERVICE1_HOST SERVICE1_PORT=$SERVICE1_PORT \
            SERVICE2_HOST=$SERVICE2_HOST SERVICE2_PORT=$SERVICE2_PORT \
            SERVICE3_HOST=$SERVICE3_HOST SERVICE3_PORT=$SERVICE3_PORT \
            SERVICE4_HOST=$SERVICE4_HOST SERVICE4_PORT=$SERVICE4_PORT \
            sudo -E docker compose --env-file /dev/null down || true

            echo "ðŸš€ Starting new containers with environment variables..."
            SERVICE1_HOST=$SERVICE1_HOST SERVICE1_PORT=$SERVICE1_PORT \
            SERVICE2_HOST=$SERVICE2_HOST SERVICE2_PORT=$SERVICE2_PORT \
            SERVICE3_HOST=$SERVICE3_HOST SERVICE3_PORT=$SERVICE3_PORT \
            SERVICE4_HOST=$SERVICE4_HOST SERVICE4_PORT=$SERVICE4_PORT \
            sudo -E docker compose --env-file /dev/null up -d --build

            echo "âœ… Deployment complete!"
